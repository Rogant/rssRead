<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Rss Reader</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <script src="phonegap.js"></script>
    <script src="Globalization.js"></script>

    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="http://10.0.1.17:8080/target/target-script-min.js#anonymous"></script>

    <script>
    var lenguaje = "";

    document.addEventListener("deviceready", onDeviceReady, false);
    document.addEventListener("online", onOnline, false);

    function onDeviceReady() {
        alert("onDeviceReady");
    }

    function onOnline() {
         alert("onOnline");
        if(window.localStorage.getItem("onlineFlag") > 0){
            alert("si");
            navigator.globalization.getPreferredLanguage(
                function (language) {
                    lenguaje = language.value;
                    console.log(lenguaje);
                    if(language.value == 'English'){
                        window.location = 'en/index.html';
                    }else if(language.value == 'Spanish'){
                        window.location = 'es/index.html';
                    }else{
                        window.location = 'en/index.html';
                    }
                },
                function () {
                    alert('Error getting language');
                }
            );
        }else{
            alert("no");
            window.localStorage.setItem("onlineFlag", 1);
            var db = window.openDatabase("Database", "1.0", "rssReader", 200000);
            db.transaction(populateDB, errorCB, successCB);
        }
    }

    function populateDB(tx) {
        alert("populateDB");
        tx.executeSql('DROP TABLE IF EXISTS entradas');
        tx.executeSql('CREATE TABLE IF NOT EXISTS entradas (id unique AUTOINCREMENT, nombre, descripcion, imagen)');

        var url = "http://tresdiseno.com/clientes/social_paraiso/drupal/en-feed-prueba";
        $.ajax({
            url: url,
            dataType: "xml",
            success:function(xml) {
               $(xml).find('node').each(function() {
                    var Nombre = $(this).find("Nombre").text(); 
                    
                    var Descripcion = $(this).find("Descripcion").text();
                    Descripcion = Descripcion.replace("<![CDATA[","");
                    Descripcion = Descripcion.replace("â€‹]]>","");

                    var Imagen = $(this).find("Imagen").text();

                    console.log(Nombre);
                    tx.executeSql('INSERT INTO entradas (nombre, descripcion, imagen) VALUES ('+ Nombre +','+ Descripcion +','+ Imagen +',)');
                    window.location = 'en/index.html';
               });
            }
        });
    }
    </script>
</head>
<body>

</body>
</html>