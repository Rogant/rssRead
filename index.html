<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Rss Reader</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <script src="phonegap.js"></script>
    <script src="Globalization.js"></script>

    <script src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript">
        jQuery.noConflict();
    </script>

    <script src="http://10.0.1.17:8080/target/target-script-min.js#anonymous"></script>

    <script>
    var lenguaje = "";
    var Nodos = new Array();
    var url = "http://tresdiseno.com/clientes/social_paraiso/drupal/en-feed-prueba";
    var redireccion = "";

    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {
    window.localStorage.setItem("onlineFlag", 1);
    var db = window.openDatabase("Database", "1.0", "setupTable", 200000);
            
        navigator.globalization.getPreferredLanguage(
            function (language) {
                lenguaje = language.value;
                alert(lenguaje);
                if(language.value == 'English'){
                    url = 'http://tresdiseno.com/clientes/social_paraiso/drupal/en-feed-prueba';
                    redireccion = "en/index.html";
                }else if(language.value == 'Spanish'){
                    url = 'http://tresdiseno.com/clientes/social_paraiso/drupal/es-feed-prueba';
                    redireccion = "es/index.html";
                }else{
                    url = 'http://tresdiseno.com/clientes/social_paraiso/drupal/en-feed-prueba';
                    redireccion = "en/index.html";
                }
            },
            function () {
                alert('Error getting language');
            }
        );

        url = "http://tresdiseno.com/clientes/social_paraiso/drupal/en-feed-prueba";
        alert("url " + url);
        var Contador = 1;
        jQuery.ajax({
            url: url,
            dataType: "xml",
            success:function(xml) {
               jQuery(xml).find('node').each(function() {
                    var Nombre = jQuery(this).find("Nombre").text(); 
                    
                    var Descripcion = jQuery(this).find("Descripcion").text();
                    Descripcion = Descripcion.replace("<![CDATA[","");
                    Descripcion = Descripcion.replace("â€‹]]>","");

                    var Imagen = jQuery(this).find("Imagen").text();

                    Nodos[Contador] = 'INSERT INTO entradas (id, nombre, descripcion, imagen) VALUES ('+ Contador  +', "'+ Nombre +'", "'+ Descripcion +'", "'+ Imagen +'")';
                    alert(Nodos[Contador]);

                    Contador++;
                });
            }
        });

        if(window.localStorage.getItem("onlineFlag") > 0){
            alert("redirect 1");
            window.location = redireccion;
        }else{
            db.transaction(setupTable, errorCB, successCB);
        }
    }

    function populateDB(tx) {
        tx.executeSql('DROP TABLE IF EXISTS entradas');
        tx.executeSql('CREATE TABLE IF NOT EXISTS entradas (id unique, nombre, descripcion, imagen)');
        tx.executeSql(Nodos[1]);
        tx.executeSql(Nodos[2]);
        tx.executeSql(Nodos[3]);
        tx.executeSql(Nodos[4]);

        alert("redirect 2");
        window.location = redireccion;
    }

    function errorCB(err) {
        alert("Error processing SQL: "+err.code);
    }

    function successCB() {
        alert("success!");
    }    
    </script>
</head>
<body>

</body>
</html>